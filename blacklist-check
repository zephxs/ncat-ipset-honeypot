#!/bin/bash
### return 0 if IP is valid IPv4 and if NOT already in IPset blacklists
### 
#set -x
_IP=''
while (( "$#" )); do
  case "$1" in
    -v|--verbose) _VERB='true'
      shift
      ;;
    -*|--*=) echo "Error: Unsupported flag $1" >&2
      exit 1
      ;;
    *) _IP="$1"
      shift
      ;;
  esac
done
eval set -- "$_IP"

# refresh ipset all IP list for quick check
find ${_LOGD}/ipset-all.ip -mmin +60 -exec ipset save -f ${_LOGD}/ipset-all.ip \; || ipset save -f ${_LOGD}/ipset-all.ip
_LOGD='/root/blacklist/logs'

_ISANIP(){
_ISIP $_IP || exit 1
if [[ "$_IP" =~ ^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$ ]]; then
[ "$_VERB" = 'true' ] && echo "# IP is Valid"
else
[ "$_VERB" = 'true' ] && echo "# string is NOT an IP.. skip"
  exit 1
fi
[ "$_VERB" = 'true' ] && echo
}

_ISINBL(){
for _LST in $(ipset list -n); do 
if [ "$_VERB" = 'true' ]; then
  if ipset test $_LST $_IP; then exit 1; fi
else
  if grep -q $_IP ${_LOGD}/ipset-all.ip; then exit 1; fi
fi
done
}

# Search for IP address in every blacklist configured in IPSET and exit 0 for scripts
[ "$_VERB" = 'true' ] && echo "### Blacklist-Check IP = $_IP "
_ISANIP
_ISINBL
# return 0 if reach
exit 0
